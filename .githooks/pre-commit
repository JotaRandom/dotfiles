#!/usr/bin/env bash
# Cross-platform pre-commit hook: ensure scripts/*.sh are executable in the index
set -euo pipefail

# If PowerShell is available, run the PowerShell hook on Windows
if command -v pwsh >/dev/null 2>&1; then
  pwsh -ExecutionPolicy Bypass -File "$(git rev-parse --show-toplevel)/.githooks/pre-commit.ps1"
  exit 0
fi
if command -v powershell >/dev/null 2>&1; then
  powershell -ExecutionPolicy Bypass -File "$(git rev-parse --show-toplevel)/.githooks/pre-commit.ps1"
  exit 0
fi

# Fallback: POSIX logic (for Bash)
STAGED=$(git diff --cached --name-only --diff-filter=ACM)
if [ -z "$STAGED" ]; then
  exit 0
fi

CHANGED=0
for f in $STAGED; do
  case "$f" in
    scripts/*.sh)
      if [ -f "$f" ]; then
        git update-index --chmod=+x "$f" && CHANGED=1 || true
      fi
      ;;
  esac
done

if [ "$CHANGED" -eq 1 ]; then
  echo "Marked staged scripts/*.sh as executable in index"
fi

exit 0
