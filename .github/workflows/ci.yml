name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  shell-lint:
    name: Bash lint & syntax check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
          submodules: recursive
      - name: Install shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck
      - name: Bash syntax check
        run: |
          for f in ./scripts/*.sh; do bash -n "$f"; done
      - name: Check executable bit on shebang files
        run: |
          set -e
          fail=0
          files=$(git ls-files || true)
          if [ -n "$files" ]; then
            for f in $files; do
              if [ -f "$f" ]; then
                if head -n1 "$f" | grep -q '^#!'; then
                  mode=$(git ls-files --stage "$f" | awk '{print $1}')
                  if [ "$mode" != "100755" ]; then
                    echo "$f has shebang but is not executable in index (mode: $mode). Run: git update-index --chmod=+x $f"
                    fail=1
                  fi
                fi
              fi
            done
          fi
          if [ "$fail" -eq 1 ]; then exit 1; fi
      - name: Run shellcheck
        run: |
          for f in ./scripts/*.sh; do shellcheck "$f" || true; done

  powershell-lint:
    name: PowerShell lint
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
          submodules: recursive
      - name: Install PSScriptAnalyzer
        shell: pwsh
        run: |
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser
      - name: Analyze PowerShell scripts
        shell: pwsh
        run: |
          Invoke-ScriptAnalyzer -Path scripts\*.ps1 -Recurse

  lfs-and-submodule-check:
    name: LFS & submodules
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
          submodules: recursive
      - name: Validate submodules
        run: |
          git submodule status --recursive
      - name: Check LFS tracked assets
        run: |
          git lfs ls-files || true
      - name: Check .gitattributes includes assets/**
        run: |
          grep -E '^assets/\*\* filter=lfs' .gitattributes

  stow-test:
    name: Verify modules with stow
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
          submodules: recursive
      - name: Install stow and tools
        run: |
          sudo apt-get update
          sudo apt-get install -y stow
      - name: Stow-test (create temp target and apply all modules)
        run: |
          set -e
          TMP=$(mktemp -d)
          echo "Testing stow modules with target: $TMP"
          cd modules
          # Iterate modules and try to stow to temporary directory
          for m in */ ; do
            m=$(basename "$m")
            echo "Testing module: $m"
            # Use explicit target to avoid modifying home
            stow -v -t "$TMP" "$m" || { echo "stow failed for module: $m"; exit 1; }
          done
          # Check at least one symlink was created
          SYMLINKS_COUNT=$(find "$TMP" -type l | wc -l || true)
          echo "Symlinks created: $SYMLINKS_COUNT"
          if [ "$SYMLINKS_COUNT" -lt 1 ]; then
            echo "No symlinks created by stow; verify module structure"
            ls -R "$TMP" || true
            exit 1
          fi
      - name: Cleanup
        run: |
          echo "Removing temp"; rm -rf "$TMP" || true
